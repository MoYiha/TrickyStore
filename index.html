
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>CleveresTricky</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root { --bg: #0B0B0C; --fg: #E5E7EB; --accent: #D1D5DB; --panel: #161616; --border: #333; --input-bg: #1A1A1A; --success: #34D399; --danger: #EF4444; }
        body { background-color: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
        .island-container { display: flex; justify-content: center; position: fixed; top: 10px; width: 100%; z-index: 1000; pointer-events: none; }
        .island { background: #000; color: #fff; border-radius: 30px; height: 35px; width: 120px; display: flex; align-items: center; justify-content: center; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 4px 15px rgba(0,0,0,0.5); font-size: 0.8em; font-weight: 500; opacity: 0; transform: translateY(-20px); }
        .island.active { width: auto; min-width: 200px; padding: 0 20px; opacity: 1; transform: translateY(0); }
        .island.error { background: #330000; border: 1px solid var(--danger); }
        .island.error #islandText { color: #FECACA; }
        .spinner { width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 10px; display: none; }
        .island.working .spinner { display: block; }
        .error-icon { display: none; margin-right: 10px; color: var(--danger); font-size: 1.2em; }
        .island.error .error-icon { display: block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        h1 { text-align: center; font-weight: 200; letter-spacing: 2px; margin: 25px 0; color: var(--accent); font-size: 1.5em; text-transform: uppercase; }
        .tabs { display: flex; justify-content: center; border-bottom: 1px solid var(--border); background: var(--panel); overflow-x: auto; }
        .tab { padding: 15px 20px; cursor: pointer; border-bottom: 2px solid transparent; opacity: 0.6; transition: all 0.2s; white-space: nowrap; font-size: 0.9em; letter-spacing: 1px; }
        .tab:hover { opacity: 0.9; }
        .tab.active { border-bottom-color: var(--accent); opacity: 1; color: var(--accent); }
        .content { display: none; padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        .content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h3 { margin-top: 0; font-weight: 500; color: var(--accent); font-size: 1.1em; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; min-height: 30px; }
        .row.wrap { flex-wrap: wrap; }
        label { font-size: 0.9em; color: #BBB; cursor: pointer; }
        input[type="text"], input[type="password"], textarea, select { background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 10px 12px; border-radius: 6px; width: 100%; box-sizing: border-box; font-family: inherit; transition: border-color 0.2s; font-size: 0.9em; }
        input[type="text"]:focus, textarea:focus, select:focus { border-color: var(--accent); outline: none; }
        button { background: var(--border); border: none; color: var(--fg); padding: 10px 20px; border-radius: 6px; cursor: pointer; font-family: inherit; font-weight: 500; font-size: 0.85em; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        button:hover { background: #444; }
        button:active { transform: scale(0.98); }
        button.primary { background: var(--accent); color: #000; }
        button.primary:hover { background: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        button.danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        button.danger:hover { background: var(--danger); color: #fff; }
        input[type="checkbox"].toggle { appearance: none; width: 40px; height: 22px; background: #333; border-radius: 20px; position: relative; cursor: pointer; transition: background 0.3s; }
        input[type="checkbox"].toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: #fff; border-radius: 50%; transition: transform 0.3s; }
        input[type="checkbox"].toggle:checked { background: var(--accent); }
        input[type="checkbox"].toggle:checked::after { transform: translateX(18px); }
        textarea:disabled, input:disabled, select:disabled, button:disabled { opacity: 0.5; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th { text-align: left; padding: 10px; border-bottom: 1px solid var(--border); color: #888; font-weight: 500; }
        td { padding: 10px; border-bottom: 1px solid var(--border); color: #ccc; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 10px; background: #333; font-size: 0.75em; margin-right: 5px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .section-header { font-size: 0.8em; color: #666; text-transform: uppercase; letter-spacing: 1px; margin: 15px 0 5px 0; }
        .drag-over { border-color: var(--accent) !important; background: rgba(255,255,255,0.05); }
        #dropZone:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .locked-item { border: 1px solid var(--danger); background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 6px; margin-bottom: 10px; }
        .server-item { border: 1px solid var(--border); background: #1a1a1a; padding: 10px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .status-badge { font-size: 0.75em; padding: 2px 6px; border-radius: 4px; margin-left: 10px; }
        .status-OK { background: rgba(52, 211, 153, 0.2); color: #34D399; }
        .status-ERROR { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
    </style>
</head>
<body>
    <div class="island-container"><div id="island" class="island" role="status" aria-live="polite"><div class="spinner"></div><div class="error-icon">‚ö†Ô∏è</div><span id="islandText">Notification</span></div></div>
    <h1>CleveresTricky <span style="font-size:0.5em; vertical-align:middle; color:var(--accent); opacity:0.7; border: 1px solid var(--accent); border-radius: 4px; padding: 2px 6px; margin-left: 10px;">BETA</span></h1>
    <div class="tabs" role="tablist">
        <div class="tab active" id="tab_dashboard" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="tab" id="tab_spoof" onclick="switchTab('spoof')">Spoofing</div>
        <div class="tab" id="tab_apps" onclick="switchTab('apps')">Apps</div>
        <div class="tab" id="tab_keys" onclick="switchTab('keys')">Keyboxes</div>
        <div class="tab" id="tab_guide" onclick="switchTab('guide')">üìñ Guide</div>
        <div class="tab" id="tab_editor" onclick="switchTab('editor')">Editor</div>
    </div>

    <div id="dashboard" class="content active">
        <div class="panel">
            <h3>System Control</h3>
            <div class="row"><label for="global_mode">Global Mode</label><input type="checkbox" class="toggle" id="global_mode" onchange="toggle('global_mode')"></div>
            <div class="row"><label for="tee_broken_mode">TEE Broken Mode</label><input type="checkbox" class="toggle" id="tee_broken_mode" onchange="toggle('tee_broken_mode')"></div>
            <div class="row"><label for="rkp_bypass">RKP Bypass (Strong)</label><input type="checkbox" class="toggle" id="rkp_bypass" onchange="toggle('rkp_bypass')"></div>
            <div class="row"><label for="auto_beta_fetch">Auto Beta Fetch</label><input type="checkbox" class="toggle" id="auto_beta_fetch" onchange="toggle('auto_beta_fetch')"></div>
            <div class="row"><label for="auto_keybox_check">Auto Keybox Check</label><input type="checkbox" class="toggle" id="auto_keybox_check" onchange="toggle('auto_keybox_check')"></div>
            <div class="row"><label for="auto_patch_update">Auto Patch Update</label><input type="checkbox" class="toggle" id="auto_patch_update" onchange="toggle('auto_patch_update')"></div>
            <div class="row"><label for="random_on_boot">Randomize on Boot</label><input type="checkbox" class="toggle" id="random_on_boot" onchange="toggle('random_on_boot')"></div>
            <div class="section-header">Boot Properties</div>
            <div class="row"><label for="hide_sensitive_props">Hide Sensitive Props</label><input type="checkbox" class="toggle" id="hide_sensitive_props" onchange="toggle('hide_sensitive_props')"></div>
            <div class="row"><label for="spoof_region_cn">Spoof Region (CN)</label><input type="checkbox" class="toggle" id="spoof_region_cn" onchange="toggle('spoof_region_cn')"></div>
            <div class="row"><label for="remove_magisk_32" style="color:var(--danger)">Remove Magisk 32-bit</label><input type="checkbox" class="toggle" id="remove_magisk_32" onchange="toggle('remove_magisk_32')"></div>
            <div style="margin-top:20px; border-top: 1px solid var(--border); padding-top: 15px;">
                <div class="row"><span id="keyboxStatus" style="font-size:0.9em; color:var(--success);">Active</span><button onclick="runWithState(this, 'Reloading...', reloadConfig)">Reload Config</button></div>
            </div>
        </div>
        <div class="panel"><h3>Configuration Management</h3><div class="grid-2"><button onclick="backupConfig()">Backup Config</button><button onclick="document.getElementById('restoreInput').click()">Restore Config</button><input type="file" id="restoreInput" style="display:none" onchange="restoreConfig(this)" accept=".zip"></div></div>
        <div class="panel" style="text-align:center;"><h3>Community</h3><div id="communityCount" style="font-size:2em; font-weight:300; margin: 10px 0;">...</div><a href="https://t.me/cleverestech" target="_blank" style="display:inline-block; margin-top:10px; color:var(--accent); text-decoration:none; font-size:0.9em; border:1px solid var(--border); padding:5px 15px; border-radius:15px;">Join Channel</a></div>
    </div>

    <div id="spoof" class="content">
        <div class="panel">
            <h3>DRM / Streaming</h3>
            <div class="row"><label for="drm_fix">Netflix / DRM Fix</label><div style="display:flex; align-items:center; gap:10px;"><button onclick="editDrmConfig()" style="padding:5px 10px; font-size:0.75em;">Edit</button><input type="checkbox" class="toggle" id="drm_fix" onchange="toggle('drm_fix')"></div></div>
            <div class="row"><label for="random_drm_on_boot">Randomize on Boot</label><input type="checkbox" class="toggle" id="random_drm_on_boot" onchange="toggle('random_drm_on_boot')"></div>
            <div class="row" style="margin-top:10px;"><label style="font-size:0.8em; color:#888;">Reset Identity</label><button onclick="runWithState(this, 'Regenerating...', resetDrmId)" style="font-size:0.75em;">Regenerate DRM ID</button></div>
        </div>
        <div class="panel"><h3>Beta Profile Fetcher</h3><button onclick="runWithState(this, 'Fetching...', fetchBeta)" style="width:100%">Fetch & Apply Latest Beta</button></div>
        <div class="panel">
            <h3>Identity Manager</h3>
            <select id="templateSelect" onchange="previewTemplate()" style="margin-bottom:15px;"></select>
            <div id="templatePreview" style="background:var(--input-bg); border-radius:8px; padding:15px; margin-bottom:15px;">
                <div class="grid-2"><div><div class="section-header">Device</div><div id="pModel"></div></div><div><div class="section-header">Manufacturer</div><div id="pManuf"></div></div></div>
                <div class="section-header">Fingerprint</div><div style="font-family:monospace; font-size:0.8em; color:#999; word-break:break-all;" id="pFing"></div>
            </div>
            <div class="grid-2"><button onclick="runWithState(this, 'Generating...', generateRandomIdentity)" class="primary">Generate Random</button><button onclick="runWithState(this, 'Applying...', applyTemplateToGlobal)">Apply Global</button></div>
        </div>
        <div class="panel"><h3>System-Wide Spoofing</h3>
            <div class="section-header">Modem</div><div class="grid-2"><input type="text" id="inputImei" placeholder="IMEI"><input type="text" id="inputImsi" placeholder="IMSI"></div>
            <div class="grid-2" style="margin-top:10px;"><input type="text" id="inputIccid" placeholder="ICCID"><input type="text" id="inputSerial" placeholder="Serial"></div>
            <div class="section-header">Network</div><div class="grid-2"><input type="text" id="inputWifiMac" placeholder="WiFi MAC"><input type="text" id="inputBtMac" placeholder="BT MAC"></div>
            <div class="section-header">Operator</div><div class="grid-2"><input type="text" id="inputSimIso" placeholder="ISO"><input type="text" id="inputSimOp" placeholder="Operator"></div>
            <div style="margin-top:15px; text-align:right;"><button onclick="applyTemplateToGlobal(this)" class="danger">Apply System-Wide</button></div>
        </div>
    </div>

    <div id="apps" class="content">
        <div class="panel">
            <h3>New Rule</h3>
            <div style="margin-bottom:10px;"><input type="text" id="appPkg" list="pkgList" placeholder="Package Name" oninput="toggleAddButton()"><datalist id="pkgList"></datalist></div>
            <div class="grid-2" style="margin-bottom:10px;"><select id="appTemplate"><option value="null">No Identity Spoof</option></select><input type="text" id="appKeybox" list="keyboxList" placeholder="Custom Keybox"><datalist id="keyboxList"></datalist></div>
            <div class="section-header">Blank Permissions</div><div style="display:flex; gap:15px;"><div class="row"><input type="checkbox" id="permContacts" class="toggle"><label>Contacts</label></div><div class="row"><input type="checkbox" id="permMedia" class="toggle"><label>Media</label></div></div>
            <button id="btnAddRule" class="primary" style="width:100%" onclick="addAppRule()" disabled>Add Rule</button>
        </div>
        <div class="panel">
            <h3>Active Rules</h3><input type="search" id="appFilter" placeholder="Filter..." oninput="renderAppTable()" style="width:100%; margin-bottom:10px;">
            <table id="appTable"><thead><tr><th>Package</th><th>Profile</th><th>Keybox</th><th></th></tr></thead><tbody></tbody></table>
            <div style="margin-top:15px; text-align:right;"><button onclick="runWithState(this, 'Saving...', saveAppConfig)" class="primary">Save Configuration</button></div>
        </div>
    </div>

    <div id="keys" class="content">
        <div id="lockedSection" style="display:none;">
            <div class="panel" style="border-color:var(--danger);">
                <h3 style="color:var(--danger);">üîê Encrypted Keyboxes Detected</h3>
                <div id="lockedList"></div>
            </div>
        </div>

        <div class="panel">
            <h3>Remote Servers</h3>
            <div id="serverList"></div>
            <button onclick="document.getElementById('addServerForm').style.display='block'" class="primary" style="width:100%">+ Add Server</button>

            <div id="addServerForm" style="display:none; margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
                <input type="text" id="srvName" placeholder="Name" style="margin-bottom:5px;">
                <input type="text" id="srvUrl" placeholder="URL (HTTPS)" style="margin-bottom:5px;">
                <select id="srvAuthType" style="margin-bottom:5px;">
                    <option value="NONE">No Auth</option>
                    <option value="BEARER">Bearer Token</option>
                    <option value="BASIC">Basic Auth</option>
                    <option value="API_KEY">API Key</option>
                </select>
                <div id="authFields"></div>
                <button onclick="addServer()" class="primary">Save Server</button>
            </div>
        </div>

        <div class="panel">
            <h3>Upload Keybox / CBOX</h3>
            <div id="dropZone" role="button" tabindex="0" style="border: 2px dashed var(--border); border-radius: 6px; padding: 20px; text-align: center; margin-bottom: 10px; cursor: pointer;" onclick="document.getElementById('kbFilePicker').click()">
                <input type="file" id="kbFilePicker" style="display:none" onchange="handleUpload(this)">
                <div id="dropZoneContent"><div style="font-size: 2em; margin-bottom: 10px;">üìÇ</div><div style="font-size: 0.9em; color: #888;">Select .xml, .cbox, or .zip</div></div>
            </div>
        </div>
        <div class="panel">
            <h3>Active Keyboxes</h3>
            <div id="storedKeyboxesList" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
        <div class="panel">
            <div class="row"><h3>Verification</h3><button onclick="runWithState(this, 'Verifying...', verifyKeyboxes)">Check All</button></div>
            <div id="verifyResult" style="font-family:monospace; font-size:0.85em;"></div>
        </div>
    </div>

    <div id="guide" class="content">
        <div class="panel">
            <h3>Encrypted Keybox Distribution</h3>
            <p>This module supports secure keybox distribution formats to protect key material.</p>

            <h4>1. .cbox Files</h4>
            <p>Encrypted containers that require a password. Once unlocked, they are cached securely on your device using hardware encryption (if available).</p>

            <h4>2. Remote Servers</h4>
            <p>Fetch keyboxes automatically from community servers. Supports authentication (Tokens, Telegram, etc).</p>

            <h4>3. Creating .cbox Files</h4>
            <p>Use the <b>Encryptor App</b> to create .cbox files from your raw XML keyboxes.</p>
            <ul>
                <li>Generate a signing key in the app.</li>
                <li>Select your keybox.xml.</li>
                <li>Set a password and author name.</li>
                <li>Share the .cbox file and Public Key with users.</li>
            </ul>
        </div>
    </div>

    <div id="editor" class="content">
        <div class="panel">
            <div class="row"><select id="fileSelector" onchange="loadFile()" style="width:70%;"><option value="target.txt">target.txt</option><option value="security_patch.txt">security_patch.txt</option><option value="spoof_build_vars">spoof_build_vars</option><option value="app_config">app_config</option><option value="drm_fix">drm_fix</option></select><button id="saveBtn" onclick="handleSave(this)">Save</button></div>
            <textarea id="fileEditor" style="height:500px; font-family:monospace; margin-top:10px; line-height:1.4;" oninput="updateSaveButtonState()"></textarea>
        </div>
    </div>

    <script>
        const baseUrl = '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        function getAuthUrl(path) { return path; }
        async function fetchAuth(url, options = {}) {
            if (!token) throw new Error('No token');
            const headers = options.headers || {};
            headers['X-Auth-Token'] = token;
            return fetch(url, { ...options, headers });
        }
        function notify(msg, type = 'normal') {
            const island = document.getElementById('island');
            document.getElementById('islandText').innerText = msg;
            island.className = 'island active ' + type;
            setTimeout(() => island.classList.remove('active'), 3000);
        }
        async function runWithState(btn, text, task) {
             const orig = btn.innerText; btn.disabled = true; btn.innerText = text;
             try { await task(); } finally { btn.disabled = false; btn.innerText = orig; }
        }
        function switchTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab_' + id).classList.add('active');
            document.getElementById(id).classList.add('active');
            if (id === 'apps') loadAppConfig();
            if (id === 'keys') loadKeyInfo();
        }

        // --- Keys Tab Logic ---
        async function loadKeyInfo() {
            loadKeyboxes(); // existing

            // Load CBOX Status
            try {
                const res = await fetchAuth('/api/cbox_status');
                const data = await res.json();

                // Locked
                const lockedList = document.getElementById('lockedList');
                lockedList.innerHTML = '';
                if (data.locked.length > 0) {
                    document.getElementById('lockedSection').style.display = 'block';
                    data.locked.forEach(f => {
                        const div = document.createElement('div');
                        div.className = 'locked-item';
                        div.innerHTML = `<div style="font-weight:bold; margin-bottom:5px;">${f}</div>
                        <input type="password" id="pwd_${f}" placeholder="Password" style="margin-bottom:5px;">
                        <textarea id="pk_${f}" placeholder="Public Key (Optional)" style="height:60px; font-size:0.8em; margin-bottom:5px;"></textarea>
                        <button onclick="unlockCbox('${f}')">Unlock</button>`;
                        lockedList.appendChild(div);
                    });
                } else {
                    document.getElementById('lockedSection').style.display = 'none';
                }

                // Servers
                const srvList = document.getElementById('serverList');
                srvList.innerHTML = '';
                if (data.server_status && data.server_status.length > 0) {
                    data.server_status.forEach(s => {
                       // We reload full server list from /api/servers usually, this just has status
                    });
                }
                loadServers();
            } catch(e) {}
        }

        async function unlockCbox(filename) {
            const pwd = document.getElementById('pwd_' + filename).value;
            const pk = document.getElementById('pk_' + filename).value;
            try {
                const formData = new FormData();
                formData.append('filename', filename);
                formData.append('password', pwd);
                formData.append('public_key', pk);
                const res = await fetchAuth('/api/unlock_cbox', { method: 'POST', body: formData });
                if (res.ok) { notify('Unlocked!'); loadKeyInfo(); } else { notify('Failed', 'error'); }
            } catch(e) { notify('Error', 'error'); }
        }

        async function loadServers() {
            const res = await fetchAuth('/api/servers');
            const servers = await res.json();
            const list = document.getElementById('serverList');
            list.innerHTML = '';
            servers.forEach(s => {
                const div = document.createElement('div');
                div.className = 'server-item';
                div.innerHTML = `<div><div style="font-weight:bold">${s.name}</div><div style="font-size:0.8em; color:#888;">${s.url}</div></div>
                <div><span class="status-badge status-${s.lastStatus.startsWith('OK')?'OK':'ERROR'}">${s.lastStatus}</span>
                <button style="padding:4px 8px; margin-left:10px;" onclick="refreshServer('${s.id}')">‚Üª</button>
                <button class="danger" style="padding:4px 8px; margin-left:5px;" onclick="deleteServer('${s.id}')">√ó</button></div>`;
                list.appendChild(div);
            });
        }

        async function addServer() {
            const name = document.getElementById('srvName').value;
            const url = document.getElementById('srvUrl').value;
            const authType = document.getElementById('srvAuthType').value;
            // Collect auth data based on type (simplified for now)
            const data = { name, url, authType };

            try {
                const formData = new FormData();
                formData.append('data', JSON.stringify(data));
                const res = await fetchAuth('/api/server/add', { method: 'POST', body: formData });
                if (res.ok) { notify('Server Added'); document.getElementById('addServerForm').style.display='none'; loadServers(); }
                else notify('Failed', 'error');
            } catch(e) { notify('Error', 'error'); }
        }

        async function deleteServer(id) {
            if(!confirm('Delete server?')) return;
            try {
                const formData = new FormData();
                formData.append('id', id);
                await fetchAuth('/api/server/delete', { method: 'POST', body: formData });
                loadServers();
            } catch(e) {}
        }

        async function refreshServer(id) {
            try {
                notify('Refreshing...', 'working');
                const formData = new FormData();
                formData.append('id', id);
                const res = await fetchAuth('/api/server/refresh', { method: 'POST', body: formData });
                if(res.ok) { notify('Refreshed'); loadServers(); } else { notify('Failed', 'error'); }
            } catch(e) {}
        }

        async function handleUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('filename', file.name);

                notify('Uploading...', 'working');
                try {
                    const res = await fetchAuth('/api/upload_keybox', { method: 'POST', body: formData });
                    if (res.ok) { notify('Uploaded'); loadKeyInfo(); } else { notify('Failed', 'error'); }
                } catch(e) { notify('Error', 'error'); }
            }
        }

        // Rest of existing JS (simplified/merged)
        async function init() {
            if (!token) return;
            try {
                const res = await fetchAuth(getAuthUrl('/api/config'));
                const data = await res.json();
                ['global_mode', 'tee_broken_mode', 'rkp_bypass', 'auto_beta_fetch', 'auto_keybox_check', 'random_on_boot', 'drm_fix', 'random_drm_on_boot', 'auto_patch_update', 'hide_sensitive_props', 'spoof_region_cn', 'remove_magisk_32'].forEach(k => {
                    if(document.getElementById(k)) document.getElementById(k).checked = data[k];
                });
                document.getElementById('keyboxStatus').innerText = `${data.keybox_count} Keys Loaded`;
            } catch(e) {}

            fetchAuth(getAuthUrl('/api/stats')).then(r => r.json()).then(d => document.getElementById('communityCount').innerText = d.members);
            const tRes = await fetchAuth(getAuthUrl('/api/templates'));
            const templates = await tRes.json();
            const sel = document.getElementById('templateSelect');
            const appSel = document.getElementById('appTemplate');
            templates.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id; opt.text = `${t.model} (${t.manufacturer})`; opt.dataset.json = JSON.stringify(t);
                sel.appendChild(opt.cloneNode(true)); appSel.appendChild(opt);
            });
            previewTemplate();
            fetchAuth(getAuthUrl('/api/packages')).then(r => r.json()).then(pkgs => {
                const dl = document.getElementById('pkgList');
                pkgs.forEach(p => { const opt = document.createElement('option'); opt.value = p; dl.appendChild(opt); });
            });
            loadKeyboxes();
            currentFile = document.getElementById('fileSelector').value;
            await loadFile();
        }

        async function toggle(setting) { const el = document.getElementById(setting); try { await fetchAuth('/api/toggle', {method:'POST', body: new URLSearchParams({setting, value: el.checked})}); notify('Updated'); } catch(e){ el.checked=!el.checked; } }

        function editDrmConfig() {
            document.getElementById('fileSelector').value = 'drm_fix';
            switchTab('editor');
            loadFile();
        }
        async function resetDrmId() {
            if (!confirm('This will delete downloaded DRM licenses and reset the device ID for streaming apps. Continue?')) return;
            try { await fetchAuth('/api/reset_drm', { method: 'POST' }); notify('DRM ID Reset'); } catch(e) { notify('Failed', 'error'); }
        }
        async function fetchBeta() {
            try {
                const res = await fetchAuth('/api/fetch_beta', { method: 'POST' });
                const text = await res.text();
                if (res.ok) notify(text); else notify(text, 'error');
            } catch(e) { notify('Fetch Failed', 'error'); }
        }

        function previewTemplate() {
            const sel = document.getElementById('templateSelect'); if (!sel.selectedOptions.length) return;
            const t = JSON.parse(sel.selectedOptions[0].dataset.json);
            document.getElementById('pModel').innerText = t.model; document.getElementById('pManuf').innerText = t.manufacturer; document.getElementById('pFing').innerText = t.fingerprint;
            if (!sel.dataset.lockExtras) {
                document.getElementById('inputImei').value = '';
                document.getElementById('inputSerial').value = '';
            }
            delete sel.dataset.lockExtras;
        }

        async function generateRandomIdentity() {
            const res = await fetchAuth('/api/random_identity');
            if (!res.ok) { notify('Failed'); return; }
            const t = await res.json();
            document.getElementById('inputImei').value = t.imei || '';
            document.getElementById('inputImsi').value = t.imsi || '';
            document.getElementById('inputIccid').value = t.iccid || '';
            document.getElementById('inputSerial').value = t.serial || '';
            document.getElementById('inputWifiMac').value = t.wifiMac || '';
            document.getElementById('inputBtMac').value = t.btMac || '';
            document.getElementById('inputSimIso').value = t.simCountryIso || '';
            document.getElementById('inputSimOp').value = t.carrier || '';
            document.getElementById('pModel').innerText = t.model + ' (Randomized)';
            document.getElementById('pManuf').innerText = t.manufacturer;
            document.getElementById('pFing').innerText = t.fingerprint;
            const sel = document.getElementById('templateSelect');
            sel.dataset.generated = JSON.stringify(t);
            notify('Identity Generated');
        }

        async function loadKeyboxes() {
            try {
                const res = await fetchAuth('/api/keyboxes');
                if (res.ok) {
                    const keys = await res.json();
                    const list = document.getElementById('storedKeyboxesList');
                    list.innerHTML = '';
                    keys.forEach(k => {
                        const div = document.createElement('div'); div.className = 'row'; div.style.padding = '10px'; div.style.borderBottom = '1px solid var(--border)';
                        div.innerHTML = `<span>${k}</span><span style="font-size:0.8em; color:#666; margin-left:10px;">Stored</span>`;
                        list.appendChild(div);
                    });
                    const dl = document.getElementById('keyboxList');
                    if (dl) { dl.innerHTML = ''; keys.forEach(k => { const opt = document.createElement('option'); opt.value = k; dl.appendChild(opt); }); }
                }
            } catch(e) {}
        }

        async function saveAdvancedSpoof() { notify('Use "Apply Global" to save'); }

        let appRules = [];
        async function loadAppConfig() {
            const res = await fetchAuth(getAuthUrl('/api/app_config_structured'));
            appRules = await res.json();
            renderAppTable();
        }
        function renderAppTable() {
            const filter = document.getElementById('appFilter') ? document.getElementById('appFilter').value.toLowerCase() : '';
            const tbody = document.querySelector('#appTable tbody');
            tbody.innerHTML = '';
            if (appRules.length === 0) {
                const tr = document.createElement('tr'); tr.innerHTML = '<td colspan="5" style="text-align:center; padding:20px; color:#666;">No active rules.</td>'; tbody.appendChild(tr); return;
            }
            appRules.forEach((rule, idx) => {
                if (filter && !rule.package.toLowerCase().includes(filter)) return;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${rule.package}</td><td>${rule.template === 'null' ? 'Default' : rule.template}</td><td>${rule.keybox && rule.keybox !== 'null' ? rule.keybox : ''}</td><td style="text-align:right;"><button class="danger" onclick="removeAppRule(${idx})">√ó</button></td>`;
                tbody.appendChild(tr);
            });
        }
        function addAppRule() {
            const pkgInput = document.getElementById('appPkg');
            const pkg = pkgInput.value.trim();
            const tmpl = document.getElementById('appTemplate').value;
            const kb = document.getElementById('appKeybox').value;
            const pContacts = document.getElementById('permContacts').checked;
            const pMedia = document.getElementById('permMedia').checked;
            if (!pkg) { notify('Package required'); return; }
            if (!/^[a-zA-Z0-9_.*]+$/.test(pkg)) { notify('Invalid package'); return; }
            const permissions = [];
            if (pContacts) permissions.push('CONTACTS');
            if (pMedia) permissions.push('MEDIA');
            appRules.push({ package: pkg, template: tmpl === 'null' ? '' : tmpl, keybox: kb, permissions: permissions });
            renderAppTable(); pkgInput.value = ''; toggleAddButton(); notify('Rule Added');
        }
        function removeAppRule(idx) {
            if (confirm('Remove rule?')) { appRules.splice(idx, 1); renderAppTable(); }
        }
        async function saveAppConfig() {
            const res = await fetchAuth(getAuthUrl('/api/app_config_structured'), { method: 'POST', body: new URLSearchParams({ data: JSON.stringify(appRules) }) });
            if (res.ok) notify('Saved'); else notify('Failed', 'error');
        }
        function toggleAddButton() {
            const btn = document.getElementById('btnAddRule'); const input = document.getElementById('appPkg');
            if (btn && input) btn.disabled = !input.value.trim();
        }
        async function reloadConfig() {
            await fetchAuth(getAuthUrl('/api/reload'), { method: 'POST' }); notify('Reloaded'); setTimeout(() => window.location.reload(), 1000);
        }
        async function backupConfig() { window.location.href = getAuthUrl('/api/backup') + '?token=' + token; }
        async function restoreConfig(input) {
            if (input.files && input.files[0]) {
                const formData = new FormData(); formData.append('file', input.files[0]);
                notify('Restoring...', 'working');
                try {
                    const res = await fetchAuth(getAuthUrl('/api/restore'), { method: 'POST', body: formData });
                    if (res.ok) { notify('Success'); setTimeout(() => window.location.reload(), 1000); } else notify('Failed', 'error');
                } catch (e) { notify('Error', 'error'); }
                input.value = '';
            }
        }

        async function loadFile() {
            const f = document.getElementById('fileSelector').value;
            const editor = document.getElementById('fileEditor');
            currentFile = f;
            try { const res = await fetchAuth('/api/file?filename=' + f); if(res.ok) editor.value = await res.text(); } catch(e){}
        }
        async function handleSave(btn) {
             btn.disabled = true; btn.innerText = 'Saving...';
             try { await fetchAuth('/api/save', { method: 'POST', body: new URLSearchParams({ filename: currentFile, content: document.getElementById('fileEditor').value }) }); notify('Saved'); } finally { btn.disabled = false; btn.innerText = 'Save'; }
        }
        function updateSaveButtonState() {} // placeholder

        init();
    </script>
</body>
</html>
