
<!DOCTYPE html>
<html>
<head>
    <title>CleveresTricky</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { background-color: #000000; color: #ffffff; font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; font-weight: 300; letter-spacing: 2px; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #333; border-radius: 0; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        button { padding: 10px 20px; background-color: #000; color: #fff; border: 1px solid #fff; cursor: pointer; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; transition: background 0.2s, color 0.2s; }
        button:hover { background-color: #fff; color: #000; }
        button:disabled { border-color: #555; color: #555; }
        textarea, input[type="text"], select { width: 100%; background-color: #000; color: #fff; border: 1px solid #555; padding: 10px; font-family: monospace; box-sizing: border-box; }
        select { margin-bottom: 10px; }
        input[type="checkbox"] { accent-color: #fff; transform: scale(1.2); }
        .status { text-align: center; color: #888; margin-top: 10px; font-family: monospace; }
        .footer { margin-top: 40px; border-top: 1px solid #333; padding-top: 20px; font-size: 0.8em; color: #666; text-align: center; }
        .footer a { color: #fff; text-decoration: none; border-bottom: 1px dotted #666; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #fff; color: #000; padding: 10px 20px; border: 1px solid #000; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000; font-family: monospace; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>
    <h1>CLEVERESTRICKY <span style="font-size: 0.4em; border: 1px solid #fff; padding: 2px 4px; vertical-align: middle;">BETA</span></h1>

    <div class="section">
        <div class="row"><label for="global_mode">Global Mode</label><input type="checkbox" id="global_mode" onchange="toggle('global_mode')"></div>
        <div class="row"><label for="tee_broken_mode">TEE Broken Mode</label><input type="checkbox" id="tee_broken_mode" onchange="toggle('tee_broken_mode')"></div>
        <div class="row"><label for="rkp_bypass">RKP Bypass (Strong Integrity)</label><input type="checkbox" id="rkp_bypass" onchange="toggle('rkp_bypass')"></div>
        <div class="row"><label for="auto_beta_fetch">Auto Pixel Beta Fetch (Daily)</label><input type="checkbox" id="auto_beta_fetch" onchange="toggle('auto_beta_fetch')"></div>
        <div class="row"><label for="auto_keybox_check">Auto Keybox Revocation Check (Daily)</label><input type="checkbox" id="auto_keybox_check" onchange="toggle('auto_keybox_check')"></div>
        <div class="row" style="margin-top: 15px; justify-content: flex-end;">
            <button onclick="fetchBetaNow()">Fetch Beta Fingerprint</button>
        </div>
        <div class="status" id="keyboxStatus" aria-live="polite">Keybox Status: Loading...</div>
    </div>

    <div class="section">
        <h3 style="font-weight: normal; border-bottom: 1px solid #333; padding-bottom: 5px;">KEYBOX JUKEBOX</h3>
        <div style="margin-bottom: 15px; font-size: 0.8em; color: #888;">Upload multiple XML files to automatically rotate keys.</div>
        <input type="text" id="kbFilename" placeholder="filename.xml (e.g., keybox_01.xml)" style="margin-bottom: 10px;">
        <textarea id="kbContent" placeholder="Paste keybox.xml content here..." style="height: 100px; margin-bottom: 10px;"></textarea>
        <div class="row" style="justify-content: flex-end;">
            <button onclick="uploadKeybox()" style="width: 100%;">UPLOAD TO POOL</button>
        </div>
        <div class="row" style="margin-top: 10px; justify-content: flex-end;">
             <button onclick="verifyKeyboxes()" style="width: 100%; border-color: #888;">VERIFY KEYBOXES</button>
        </div>
        <div id="verifyResult" style="margin-top: 10px; font-family: monospace; font-size: 0.8em; white-space: pre-wrap;"></div>
    </div>

    <div class="section">
        <select id="fileSelector" onchange="loadFile()" aria-label="Select configuration file">
            <option value="keybox.xml">keybox.xml</option>
            <option value="target.txt">target.txt</option>
            <option value="security_patch.txt">security_patch.txt</option>
            <option value="spoof_build_vars">spoof_build_vars</option>
            <option value="app_config">app_config (App Specific)</option>
        </select>

        <div id="templateSection" style="display:none; margin-bottom: 10px;">
             <div class="row">
                <select id="templateSelector" style="flex-grow: 1; margin-right: 10px;" aria-label="Select device template">
                    <option value="" disabled selected>Select template...</option>
                </select>
                <button onclick="applyTemplate()">LOAD</button>
             </div>
        </div>

        <textarea id="editor" aria-label="Configuration editor" style="height: 300px;"></textarea>
        <div class="row" style="margin-top: 10px; justify-content: flex-end;">
            <button id="saveBtn" onclick="saveFile()">SAVE FILE</button>
        </div>
    </div>

    <div class="section" style="text-align: center; border: none;">
        <button id="reloadBtn" onclick="reloadConfig()" style="width: 100%;">RELOAD CONFIG</button>
    </div>

    <div class="footer">
        Designed with simplicity for system optimization and performance.<br>
        <br>
        <a href="https://t.me/cleverestech">t.me/cleverestech</a>
    </div>

    <script>
        const baseUrl = '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        function getAuthUrl(path) {
            return path + (path.includes('?') ? '&' : '?') + 'token=' + token;
        }

        let toastTimeout;
        function showToast(msg) {
            let t = document.getElementById('toast');
            if (!t) { t = document.createElement('div'); t.id = 'toast'; t.className = 'toast'; document.body.appendChild(t); }
            t.textContent = msg; t.className = 'toast show';
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { t.className = t.className.replace('show', ''); }, 3000);
        }

        async function init() {
            if (!token) {
                document.body.innerHTML = '<h1 style="color:white;text-align:center;margin-top:50px;">UNAUTHORIZED</h1>';
                return;
            }
            const res = await fetch(getAuthUrl(baseUrl + '/config'));
            if (!res.ok) {
                alert('Failed to load config: ' + res.status);
                return;
            }
            const data = await res.json();
            document.getElementById('global_mode').checked = data.global_mode;
            document.getElementById('tee_broken_mode').checked = data.tee_broken_mode;
            document.getElementById('tee_broken_mode').checked = data.tee_broken_mode;
            document.getElementById('rkp_bypass').checked = data.rkp_bypass;
            document.getElementById('auto_beta_fetch').checked = data.auto_beta;
            document.getElementById('auto_keybox_check').checked = data.auto_keybox_check;

            const count = data.keybox_count;
            const statusEl = document.getElementById('keyboxStatus');
            if (count > 0) {
                statusEl.innerText = 'Keybox Status: ACTIVE (' + count + ' keys loaded)';
                statusEl.style.color = '#fff';
            } else {
                statusEl.innerText = 'Keybox Status: INACTIVE (No keys)';
                statusEl.style.color = '#555';
            }

            const tmplSel = document.getElementById('templateSelector');
            if (data.templates) {
                data.templates.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.innerText = t;
                    tmplSel.appendChild(opt);
                });
            }

            loadFile();
        }

        async function toggle(setting) {
            const el = document.getElementById(setting);
            const val = el.checked;
            const originalOpacity = el.style.opacity;
            el.disabled = true;
            el.style.opacity = '0.5';

            try {
                const res = await fetch(getAuthUrl(baseUrl + '/toggle'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'setting=' + setting + '&value=' + val
                });
                if (res.ok) {
                    showToast('SETTING UPDATED');
                } else {
                    throw new Error('Server error');
                }
            } catch (e) {
                el.checked = !val;
                showToast('UPDATE FAILED');
            } finally {
                el.disabled = false;
                el.style.opacity = originalOpacity;
            }
        }

        async function loadFile() {
            const filename = document.getElementById('fileSelector').value;

            const tmplSection = document.getElementById('templateSection');
            if (filename === 'spoof_build_vars' || filename === 'app_config') {
                tmplSection.style.display = 'block';
            } else {
                tmplSection.style.display = 'none';
            }

            const res = await fetch(getAuthUrl(baseUrl + '/file?filename=' + filename));
            const text = await res.text();
            document.getElementById('editor').value = text;
        }

        function applyTemplate() {
            const tmpl = document.getElementById('templateSelector').value;
            const filename = document.getElementById('fileSelector').value;
            if (!tmpl) return;
            const editor = document.getElementById('editor');
            const current = editor.value;

            if (filename === 'app_config') {
                editor.value = current + (current.length > 0 && !current.endsWith('\n') ? '\n' : '') + '# New entry\ncom.example.package ' + tmpl + ' keybox.xml\n';
            } else {
                if (current.includes('TEMPLATE=')) {
                    if (!confirm('Replace existing TEMPLATE directive?')) return;
                    editor.value = current.replace(/TEMPLATE=[^\n]*/, 'TEMPLATE=' + tmpl);
                } else {
                    editor.value = 'TEMPLATE=' + tmpl + '\n' + current;
                }
            }
        }

        async function uploadKeybox() {
            const filename = document.getElementById('kbFilename').value;
            const content = document.getElementById('kbContent').value;
            if (!filename || !content) { showToast('MISSING INFO'); return; }
            if (!filename.endsWith('.xml')) { showToast('MUST BE .XML'); return; }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'UPLOADING...';

            try {
                const params = new URLSearchParams();
                params.append('filename', filename);
                params.append('content', content);

                const res = await fetch(getAuthUrl(baseUrl + '/upload_keybox'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: params
                });

                if (res.ok) {
                    showToast('UPLOADED');
                    document.getElementById('kbFilename').value = '';
                    document.getElementById('kbContent').value = '';
                    setTimeout(init, 1000);
                } else {
                    const txt = await res.text();
                    showToast('FAILED: ' + txt);
                }
            } catch (e) {
                showToast('ERROR');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function verifyKeyboxes() {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'VERIFYING...';
            const resDiv = document.getElementById('verifyResult');
            resDiv.innerText = '';

            try {
                const res = await fetch(getAuthUrl(baseUrl + '/verify_keyboxes'), { method: 'POST' });
                if (!res.ok) throw new Error('Failed');
                const data = await res.json();

                let html = '';
                let hasIssues = false;
                data.forEach(item => {
                    let color = '#0f0';
                    if (item.status !== 'VALID') { color = '#f00'; hasIssues = true; }
                    html += '<div style="color:' + color + '">[' + item.status + '] ' + item.filename + '</div>';
                    if (item.details) html += '<div style="color:#888; margin-left: 10px;">' + item.details + '</div>';
                });
                resDiv.innerHTML = html;

                if (hasIssues) showToast('ISSUES FOUND');
                else showToast('ALL VALID');

            } catch (e) {
                showToast('ERROR');
                resDiv.innerText = 'Verification failed.';
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function saveFile() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'SAVING...';

            try {
                const filename = document.getElementById('fileSelector').value;
                const content = document.getElementById('editor').value;
                const params = new URLSearchParams();
                params.append('filename', filename);
                params.append('content', content);

                const res = await fetch(getAuthUrl(baseUrl + '/save'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: params
                });

                if (res.ok) showToast('SAVED');
                else showToast('SAVE FAILED');
            } catch (e) {
                showToast('ERROR');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function fetchBetaNow() {
            if (!confirm("Overwrite spoof_build_vars with latest Beta fingerprint?")) return;
            const btn = event.target;
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'FETCHING...';

            try {
                const res = await fetch(getAuthUrl(baseUrl + '/fetch_beta'), { method: 'POST' });
                const text = await res.text();
                if (res.ok) {
                    showToast('SUCCESS: ' + text);
                    loadFile();
                } else {
                    showToast('FAILED');
                }
            } catch (e) {
                showToast('ERROR');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function reloadConfig() {
            const btn = document.getElementById('reloadBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'RELOADING...';

            try {
                const res = await fetch(getAuthUrl(baseUrl + '/reload'), { method: 'POST' });
                if (res.ok) {
                    btn.innerText = 'RELOADED';
                } else {
                    btn.innerText = 'FAILED';
                }
            } catch (e) {
                btn.innerText = 'ERROR';
            }
            setTimeout(function() {
                btn.innerText = originalText;
                btn.disabled = false;
            }, 2000);
        }

        init();
    </script>
</body>
</html>
