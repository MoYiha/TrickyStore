package cleveres.tricky.cleverestech.util

import cleveres.tricky.cleverestech.Logger
import org.junit.Assert.assertFalse
import org.junit.Assert.assertTrue
import org.junit.Assert.fail
import org.junit.BeforeClass
import org.junit.Test
import java.io.File
import java.io.IOException
import java.io.StringReader

class KeyboxVerifierFailOpenTest {

    companion object {
        @JvmStatic
        @BeforeClass
        fun setup() {
             Logger.setImpl(object : Logger.LogImpl {
                override fun d(tag: String, msg: String) {}
                override fun e(tag: String, msg: String) { println("E/$tag: $msg") }
                override fun e(tag: String, msg: String, t: Throwable?) { println("E/$tag: $msg") }
                override fun i(tag: String, msg: String) {}
            })
        }
    }

    @Test
    fun testParseCrlFailOpenOnMalformedJson() {
        // 1. Setup a JSON that is valid at start but malformed halfway
        val brokenJson = """
        {
          "entries": {
            "10": { "status": "REVOKED" },
            "11": { "status": "REVOKED" },
            "12": { "stat
        """.trimIndent()

        try {
            // Explicitly use StringReader to match the main parsing method signature clearly
            KeyboxVerifier.parseCrl(StringReader(brokenJson))

            // If we reach here, it means the bug is present (it swallowed the exception)
            fail("Should have thrown an exception on malformed JSON to prevent partial revocation list loading.")
        } catch (e: Exception) {
            // Expected behavior for a secure implementation
            println("Caught expected exception: $e")
        }
    }
}
